# 객체지향쿼리

# 묵시적 조인, 명시적 조인

상태필드, 단일 값 연관필드, 컬렉션 값 연관 필드 **확실히** 알아둘 것

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%201.png)

단일 값 연관 경로에서 묵시적 내부 조인이 발생한다는 것 매우 중요함

상태필드를 조회하면

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%202.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%203.png)

이에 반해 단일값연관경로를 조회하면, 디비에서는 조인이 일어나야 함. 그래서 조인쿼리가 날라간다. 즉 묵시적인 내부조인이 발생해.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%204.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%205.png)

즉, 웬만하면 묵시적인 조인쿼리가 날라가게 쓰면 안됨. 나중에 튜닝할때 힘들어짐.

걍 결론은 **묵시적 조인 쓰지말고, 명시적 조인 써야 한다**. 그래야 쿼리 튜닝하기 쉬워진다.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%206.png)

다음 예제를 보면, 1번,2번은 성공함. (근데 이케 하는거 권장 안한다 했음 묵시적 조인 나가가지고)

3번은 실패. 왜냐면 컬렉션을 가져오는데, 컬렉션은 .(점)찍으면 암것도 안뜸. 점으로 할수있는건 .size밖에 안됨 왜냐면 타입이 ㄹㅇ Collection이라서 안들어가지는거임. (컬렉션은 경로 탐색의 끝이 되버림)

4번은 성공. 왜냐면 명시적조인으로 가지고 왔기 때문임. 별칭을 만들어서 하면 가능해짐

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%207.png)

아무튼 결론: FROM절에서 명시적 조인을 사용해라. 그래야 쿼리튜닝하기 좋다. 안그럼 쿼리날라가는거보고 이게 어디서 날라가는지 알수가 없어. 조인은 SQL튜닝의 중요포인트임.

# 페치조인

개중요하다. 아래거 무조건 이해 ㄱ

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%208.png)

- 페치조인 안쓰고 그냥 select m From Member m 해보면?

아래에 sout()안에 잘려서 안보이는데 암튼, member.getTeam.name()하면 지연로딩하니까 이때 쿼리 또 날라가. 결국 1+N 문제발생.

1+N이란 1번 쿼리날려서 나온 결과 N개만큼 최대 N개의 쿼리가 또 날라가는 문제.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%209.png)

- 페치조인을 써보면

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2010.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2011.png)

**즉, select할 때 Member안에 담기는 Team이 프록시가 아니라 실제 데이타를 가져온다는 것이다**

그래서 루프돌면서 sout할때 member.getTeam().name()을 하는데 쿼리 안날라가고 걍 영속성컨텍스트안에서 가져옴

### 일대다 패치조인

비슷한데 살짝달라. 조인할때 어쩔수없이 테이블이 길어짐.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2012.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2013.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2014.png)

디비에서는 row가 3개니까(팀A 두개, 팀B 하나) 3개뿌려줌. 디비는 자기역할 한거뿐야. 고로 List<Team>은 총 3개 데이터를 가지고 있지. 그래서 출력을 해보면 똑같은 팀A가 두번 출력되버림. 상황에 따라 다르겠지만, 난 팀 종류만 알고싶은건데 저렇게 나와버리면 안되지.

# 패치조인과 distinct

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2015.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2016.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2017.png)

2개로 줄었음. 분명 팀A는 원래 2개로 뻥튀기였는데 distinct하니까 1개만 나오게 되네.

어케 되는거냐면 **같은 식별자를 가진 Team 엔티티를 제거**한거임

# 조인과 패치조인 비교

비교해보자. 궁금했지?ㅇㅇ궁금했음. 혼자 찾아볼라했는데 강의로 알려주네

### 걍 조인(명시적)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2018.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2019.png)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2020.png)

일단 select할때 Team만 가져온다. 애초에 team만 달라했으니까 team만 조회해오는거 당연하잖아 조인은. 또한 역시나 데이터 3개 리턴됨(똑같은 팀A가 두개 찍힌거임)

근데 또 다른점은 루프에서 sout에서 team.getMembers()루프돌면서 할때마다 계속 쿼리날라감.N+1

# 패치조인의 특징과 한계

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2021.png)

- 페이지가 안되는이유?
    
    ![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2022.png)
    
    ![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2023.png)
    
    경고메시지 보면 컬렉션페치를 하니까 위험하다는거임
    
    일단 일대일,다대일은 페치조인해도 페이징 돼. 왜냐면 데이터 뻥튀기 안되니까.
    
    근데 일대다 같은 경우는 데이터 뻥튀기가 됨
    
    이유: 아래와 같은 상황에서 팀A를 가져오려 해. 그럼 페치조인해서 회원1,2 두명도 불러오니까 조인한 테이블의 row가 두개가 됨. 여기서 만약 페이징으로 size로 1만 달라고 한다면? **팀A에는 회원이 회원1만 있게 되는거임. row기준으로 하나만 디비에서 가져오는 거니까.**
    
    ![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2024.png)
    
- 해결방안

방법1: 반대로 쿼리.일대다 → 다대일

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2025.png)

쿼리 뒤집으면 되긴 함. 이럼 다대일되니까 페이징문제 없어짐

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2026.png)

방법2: 

잠시만! 일단 조인없이 걍 때려보자.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2027.png)

1. sql날라가는 거 보면, 일단 지금 팀A랑 팀B 두개 있어서 결과 2개나옴

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2028.png)

1. 글구 이제 for루프탈때 lazy loading걸려서 sql다시 나간다

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2029.png)

팀A에 관한 멤버 가져오는 쿼리 한번.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2030.png)

팀 B에 관한 멤버 가져오는데 한번.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2031.png)

고로, 지금 N+1문제가 발생. (팀 다 가져오는데 1번, 팀A의 멤버가져오는데 1번, 팀B의 멤버가져오는데 1번해서 총 3번....만약 팀이 100개면, 101번 쿼리 날라갈거임)

→해결방법은 다음처럼 하면 된다.

@ BatchSize를 준다.(적당히 1000이하의 값)

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2032.png)

글구 나머진 기존과 똑같이 페이징해보자

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2033.png)

일단 팀 가져오는건 똑같음. 팀a랑 팀b 가져오게 됨

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2034.png)

근데 이제 달라져.

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2035.png)

in 안에 물음표 두개있잖어. 쿼리 한번에 팀A랑 팀B에 연관된 멤버들을 다 가져온 것임

즉, 레이지 로딩할 때, 처음 팀가져오는 쿼리의 결과가 담긴 List<Team> result에 있는 팀들을 in쿼리에 한번에 100개씩 넘긴다(지금은  팀A랑 팀B 두개니까 두개만 넘어간거임)

- 글로벌세팅:

이제 @BatchSize 주는 거 알겠지? 더 세련되게 할라면 아래처럼 글로벌옵션으로 100개라고 하면 됨

![Untitled](%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%E1%84%8F%E1%85%AF%E1%84%85%E1%85%B5%2091c6812a5b5a42618fa59236fe612c90/Untitled%2036.png)

### 전략 결론

모두 지연로딩 걸고, **최적화가 필요한 곳(N+1문제가 터지는 곳)에만 페치조인을 적용한다.**