# ëŒ“ê¸€

# 72ê°•-Commentëª¨ë¸ ë§Œë“¤ê¸°

ëŒ“ê¸€ ëª¨ë¸ì— ë­ê°€ ë“¤ì–´ê°€ì•¼ í• ê¹Œ? ì–´ë–¤ ì´ë¯¸ì§€ì— ë‹¬ë¦¬ëŠ”ì§€, ëˆ„ê°€ ì‘ì„±í–ˆëŠ”ì§€ ì´ëŸ°ê±´ **ì˜¤ë¸Œì íŠ¸**ì„.

ì¦‰ ì—°ê´€ê´€ê³„ê°€ í•„ìš”í•´

- ë‹¤ì‹œí•œë²ˆ FetchTypeì˜ EAGERì™€ LAZYì •ë¦¬:

ManyToOneì¼ë•ŒëŠ” EAGERì„. ì™œëƒ? ì˜ˆë¥¼ë“¤ì–´ Commentëª¨ë¸ì— Userê°€ ìˆì–ì–´, ëŒ“ê¸€ í•˜ë‚˜ì—ëŠ” Userê°€ í•œëª…ë°–ì— ì—†ìœ¼ë‹ˆê¹Œ ë§¤ë‹ˆíˆ¬ì›ì¸ë°, EAGERë¡œ ëŒ“ê¸€ê°€ì ¸ì˜¬ë•Œë§ˆë‹¤ User ë‹¤ ëŒê³ ì™€ë„ ìƒê´€ì—†ì–´ ì–´ì°¨í”¼ í•˜ë‚˜ë°–ì— ì•ˆë˜ë‹ˆê¹Œ.

ê·¼ë° ë§Œì•½

OneToManyë¼ë©´, ì˜ˆë¥¼ë“¤ì–´ Userëª¨ë¸ì—ëŠ” Imageê°€ ìˆì–ì•„. Userí•œë²ˆ ë¶€ë¥¼ë•Œë§ˆë‹¤ ê·¸ ìœ ì €ê°€ ì˜¬ë¦° ì‚¬ì§„ë“¤ ì˜¤ì§€ê²Œ ë§ì€ë°, ë‹¤ ê°€ì ¸ì˜¤ê¸°ì—” ë¶€ë‹´ì´ ë¼. ê·¸ë˜ì„œ í˜¸ì¶œì‹œì—ë§Œ ë¶€ë¥´ëŠ” ê±°ì„.

ê³ ë¡œ ë‹¤ìŒì²˜ëŸ¼ Commentëª¨ë¸ì„ ë§Œë“¦

```jsx
public class Comment {
	@Id // ì–˜ë¥¼ í”„ë¼ì´ë¨¸ë¦¬í‚¤ë¡œ ì„¤ì •
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private int id;

	@Column(length = 100, nullable = false)
	private String content;
	
	@JoinColumn(name="userId")
	@ManyToOne(fetch=FetchType.EAGER)//ë§¤ë‹ˆíˆ¬ì›ì€ EAGERê°€ ë””í´íŠ¸
	private User user;
	
	@JoinColumn(name="imageId")
	@ManyToOne(fetch=FetchType.EAGER)
	private Image image;
	

	private LocalDateTime createDate;

	@PrePersist // dbì—ëŠ” í•­ìƒ ì‹œê°„ì´ í•„ìš”í•´. ì–¸ì œ ê·¸ ë°ì´í„°ê°€ ë“¤ì–´ì™”ëŠ”ì§€.
	public void createDate() {
		this.createDate = LocalDateTime.now();
	}
}
```

# 73,74ê°•-ì»¨íŠ¸ë¡¤ëŸ¬,ì„œë¹„ìŠ¤ ë§Œë“¤ê³ ,ajax ì„¤ì •

ì»¨íŠ¸ë¡¤ëŸ¬ë‘ ì„œë¹„ìŠ¤ëŠ” ì¼ë‹¨ ë‚˜ì¤‘ì— ì ê¸°. 73ê°•ì—ì„  ë¼ˆëŒ€ë§Œ ë§Œë“¦ã…‹

ì¼ë‹¨ story.jsë¡œ ì»´ì»´

í˜„ì¬ ëŒ“ê¸€ì“°ê³  ë²„íŠ¼ëˆ„ë¥´ëŠ” ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŒ-

ë‚´ê°€ idë‘ onClickí•¨ìˆ˜ ì¸ìì— **${image.id}** ì¶”ê°€í•´ì¤Œ. ì´ ëŒ“ê¸€ì´ ì–´ë–¤ ì´ë¯¸ì§€ì— ëŒ€í•œê±´ì§€ ì•Œë ¤ì¤˜ì•¼ í•˜ë‹ˆê¹Œ.

```jsx
<div class="sl__item__input">
		<input type="text" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..." id="storyCommentInput-${image.id}" />
		<button type="button" onClick="addComment(${image.id})">ê²Œì‹œ</button>
</div>
```

ëŒ“ê¸€ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì£¼ëŠ” ì½”ë“œ-

ì—¬ê¸° idì—ë„ ${image.id} ë„£ìŒ.ìš”ê²ƒë„ ê°™ì€ì´ìœ . ì´ë¯¸ì§€ë‘ ëŒ“ê¸€ì´ë‘ ì—°ê²°ë˜ì–´ì•¼ í•˜ë‹ˆê¹Œ

ì´ ëŒ“ê¸€ì½”ë“œë¥¼ ëŒ“ê¸€ì“°ê¸° ë²„íŠ¼ëˆ„ë¥¼ë•Œë§ˆë‹¤ addComment()ë¡œ appendí•˜ê² ì§€

```jsx
<div id="storyCommentList-${image.id}">
		<div class="sl__item__contents__comment" id="storyCommentItem-1"">
			<p>
				<b>Lovely :</b> ë¶€ëŸ½ìŠµë‹ˆë‹¤.
			</p>
			<button>
				<i class="fas fa-times"></i>
			</button>
		</div>
	</div>
```

addComment()í•¨ìˆ˜ì— ajaxë¥¼ ë„£ìŒ

dataì—ë‹¤ê°€ ì´ë¯¸ì§€id, ëŒ“ê¸€ë‚´ìš©ì„ ë„£ìŒ. ì‚¬ì‹¤ ê¸€ì“°ëŠ”ì‚¬ëŒidë„ í•„ìš”í•˜ì§€ë§Œ ì´ê±´ ì„¸ì…˜ê°’ ê°€ì ¸ì˜¤ë©´ ë¨.

ajaxì˜dataì— JSON.stringify(data) í•˜ëŠ” ì´ìœ ëŠ”, jsonê°ì²´ëŠ” "í‚¤":"ë²¨ë¥˜"ì²˜ëŸ¼ í‚¤ì—ë„ ìŒë”°ì›€í‘œìˆì–´ì•¼í•´ì„œê·¸ëŸ¼.

```jsx
function addComment(imageId) {

	let commentInput = $(`#storyCommentInput-${imageId}`);
	let commentList = $(`#storyCommentList-${imageId}`);

	let data = {
		imageId:imageId,
		content: commentInput.val()
	}

	if (data.content === "") {
		alert("ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”!");
		return;
	}
	
	$.ajax({
		type:"post",
		url:"/api/comment",
		data:JSON.stringify(data),
		contentType:"application/json;charset=utf-8",
		dataType:"json"
	}).done(res=>{
		console.log("ì„±ê³µ",res);
	}).fail(error=>{
		console.log("ì˜¤ë¥˜",error);
	});

	let content = `
			  <div class="sl__item__contents__comment" id="storyCommentItem-2""> 
			    <p>
			      <b>GilDong :</b>
			      ëŒ“ê¸€ ìƒ˜í”Œì…ë‹ˆë‹¤.
			    </p>
			    <button><i class="fas fa-times"></i></button>
			  </div>
	`;
	commentList.prepend(content);
	commentInput.val("");
}
```

# 75ê°•-ëŒ“ê¸€ì…ë ¥ê°’ ë””ë¹„ì— INSERTí•˜ê¸°

ì´ì œ ìœ„ì—ì„œ ë§Œë“  ajaxë¥¼ í†µí•´ dataê°ì²´ë¥¼ ë³´ë‚´ê² ì§€. ì´ê±¸ ê·¼ë° Commentëª¨ë¸ë¡œ ë°›ì„ìˆ˜ ì—†ì–´. ì™œëƒë©´ ì½”ë©˜íŠ¸ì˜ imgaeì˜ íƒ€ì…ì€ Imageê°ì²´ì¸ë°, ajaxì—ì„œ ë³´ë‚´ëŠ” dataëŠ” Stringì¸ imageIdë¥¼ ë³´ë‚´ê¸° ë•Œë¬¸

â†’ì´ë˜ì„œ DTOê°€ í•„ìš”í•œê±°

```jsx
@Data
public class CommentDto {
	private String content;
	private int imageId;
	
	//toEntityê°€ í•„ìš”ì—†ë‹¤
}
```

ì§€ê¸ˆê¹Œì§€ í–ˆë˜ê±°ì²˜ëŸ¼ ì»¨íŠ¸ë¡¤ëŸ¬ ã„±ã„±

```jsx
public class CommentApiController {

	private final CommentService commentService;

	@PostMapping("/api/comment")
	public ResponseEntity<?> commentSave(@RequestBody CommentDto commentDto,@AuthenticationPrincipal PrincipalDetails principalDetails) {
		Comment comment = commentService.ëŒ“ê¸€ì“°ê¸°(commentDto.getContent(), commentDto.getImageId(), principalDetails.getUser().getId());//content,imageId,userId ë‚ ë¦¼
		return new ResponseEntity<>(new CMRespDto<>(1,"ëŒ“ê¸€ì“°ê¸°ì„±ê³µ",comment),HttpStatus.CREATED);
	}
```

ì„œë¹„ìŠ¤

```jsx
public class CommentService {
	private final CommentRepository commentRepository;
	
	@Transactional
	public Comment ëŒ“ê¸€ì“°ê¸°(String content, int imageId, int userId){
		return commentRepository.mSave(content, imageId, userId);
	}
```

ë ˆíŒŒì§€í† ë¦¬

```jsx
public interface CommentRepository extends JpaRepository<Comment, Integer>{

	@Modifying
	@Query(value="INSERT INTO comment(content, imageId,userId, createDate) VALUES(:content,:imageId,:userId,now())",nativeQuery =true)
	Comment mSave(String content,int imageId, int userId);
}
```

ì, í•œë²ˆ ëŒ“ê¸€ì¨ë³´ë©´,  ì—ëŸ¬!!!!ğŸ˜£

why?

Modifying queries can only use void or int/Integer as return type

ì¦‰ ë ˆíŒŒì§€í† ë¦¬ì—ì„œ mSaveì˜ ë¦¬í„´íƒ€ì…ì´ voidë‚˜ intì—¬ì•¼ í•¨. ê·¼ë° ë¬´ì¡°ê±´ Commentíƒ€ì…ìœ¼ë¡œ ë°›ì•„ì•¼ í•˜ëŠ”ë°ã… ã… ì–´ìº„. ì•ˆê·¸ëŸ¬ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë¦¬í„´ìœ¼ë¡œ Commentë¥¼ ë‹´ì„ ìˆ˜ê°€ ì—†ì–´ì ¸. ê·¸ëŸ¬ë©´ ë¬´ìŠ¨ ë¬¸ì œê°€ ìƒê¸°ëƒë©´, Primary keyë¥¼ ì•Œìˆ˜ê°€ ì—†ì–´ì§. ajaxê°€ ë¦¬í„´ë°›ì•„ì„œ ëŒ“ê¸€ì‚­ì œì—ë‹¤ê°€ pkì¸ idë¥¼ ì´ìš©í•´ì„œ ì¨ë¨¹ì–´ì•¼í•´..

---

ì¦‰. Commentë¡œ ë¦¬í„´ë°›ìœ¼ë ¤ë©´ nativeì¿¼ë¦¬ë¡œ ì•ˆëœë‹¤

â†’jpaì˜ saveí•¨ìˆ˜í™œìš©

saveì •ì˜ëœê±¸ ë³´ë©´

```jsx
<S extends T> S save(S entity);
```

ì´ì¼€ ë˜ì–´ìˆìŒ. ì¦‰ ë„£ì€ íƒ€ì… ê³ ëŒ€ë¡œ ë¦¬í„´í•´ì¤˜. ê·¸ëŸ¼ ì•„ë˜ì²˜ëŸ¼ Commentë¥¼ ë§Œë“¤ê³  commentì— ë‚´ìš©ë¬¼ì„ ì±„ì›Œì£¼ë©´ ë˜ëŠ”ë°...

```jsx
public class CommentService {	private final CommentRepository commentRepository;		@Transactional	public Comment ëŒ“ê¸€ì“°ê¸°(String content, int imageId, int userId){				Comment comment = new Comment();		comment.setContent(content);		//ê·¼ë° imageë‘ userëŠ” ê°ì²´íƒ€ììœ¼ë¡œ ë„£ì–´ì¤˜ì•¼ í•˜ëŠ”ë°??		return commentRepository.save(comment);	}
```

imageë‘ userIdë¥¼ ë„£ì–´ì£¼ê³ ì‹¶ì€ë° Commentëª¨ë¸ì€ Imageê°ì²´ë‘ Userê°ì²´ë¡œë§Œ ë„£ì„ìˆ˜ìˆì–´. ì–´ë–¡?

â†’**ì§œê°€ ê°ì²´ë¥¼ ë§Œë“ ë‹¤.** ì–´ì°¨í”¼ ë‚œ imageIdë‘ userIdë§Œ ê¾¸ê²¨ë„£ìœ¼ë©´ ë¼.

```jsx
public class CommentService {
	private final CommentRepository commentRepository;
	
	@Transactional
	public Comment ëŒ“ê¸€ì“°ê¸°(String content, int imageId, int userId){
		
		//tip-ê°ì²´ë¥¼ ë§Œë“¤ë•Œ idê°’ë§Œ ë‹´ì•„ì„œ insertí• ìˆ˜ìˆë‹¤
		Image image = new Image();
		image.setId(imageId);
		User user = new User();
		user.setId(userId);
		
		Comment comment = new Comment();
		comment.setContent(content);
		comment.setImage(image);
		comment.setUser(user);
		return commentRepository.save(comment);
	}
```

ì–´ì°¨í”¼!DBì— ë“¤ì–´ê°ˆ ê°’ì€ ìš”ê±°ì„

![Untitled](https://user-images.githubusercontent.com/78577071/127448175-629c6eab-04d8-45b8-bda7-3dab2109afd6.png)


ì½”ë©˜íŠ¸ëª¨ë¸ì´ foreignkeyë¡œ ë‹¤ ë½‘ì•„ì„œ ë„£ì–´ì¤Œ

```jsx
	@JoinColumn(name="userId")
	@ManyToOne(fetch=FetchType.EAGER)//ë§¤ë‹ˆíˆ¬ì›ì€ EAGERê°€ ë””í´íŠ¸
	private User user;
	
	@JoinColumn(name="imageId")
	@ManyToOne(fetch=FetchType.EAGER)
	private Image image;
```

ì´ì œ ëŒ“ê¸€ì…ë ¥í•´ë³´ë©´ ì½˜ì†”ì— ì˜ ì°í˜

![Untitled 1](https://user-images.githubusercontent.com/78577071/127448152-c2bc8f84-f8a4-4e27-a3cc-e3c7dbed6cc6.png)

ê·¼ë° ë˜ ë¬¸ì œì ì´... ëŒ“ê¸€ì— ê¸€ ì…ë ¥í• ë•Œ usernameë„ ë³´ì´ì–ì•„. ê·¼ë° ê·¸ê±´ ì–´ì¹¼ê±°?

ë¦¬í„´ë˜ëŠ” userì—ëŠ” usernameì´ ì—†ëŠ”ë””???

â†’userRepositoryë¥¼ ì‚¬ìš©í•˜ì—¬ Userë¥¼ Commentì— ë„£ëŠ”ê±° ìˆ˜ì •

```jsx
public class CommentService {
	private final CommentRepository commentRepository;
	private final UserRepository userRepository;
	
	@Transactional
	public Comment ëŒ“ê¸€ì“°ê¸°(String content, int imageId, int userId){
		
		//tip-ê°ì²´ë¥¼ ë§Œë“¤ë•Œ idê°’ë§Œ ë‹´ì•„ì„œ insertí• ìˆ˜ìˆë‹¤
		//ëŒ€ì‹  returnì‹œì— imageê°ì²´ì™€ userê°ì²´ëŠ” idê°’ë§Œ ê°€ì§€ê³  ìˆëŠ” ë¹ˆ ê°ì²´ë¥¼ ë¦¬í„´ë°›ìŒ
		Image image = new Image();
		image.setId(imageId);
		
		User userEntity = userRepository.findById(userId).orElseThrow(()->{
			throw new CustomApiException("ìœ ì € ì•„ì´ë””ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
		});
				
		Comment comment = new Comment();
		comment.setContent(content);
		comment.setImage(image);
		comment.setUser(userEntity);
		return commentRepository.save(comment);
	}
```
![Untitled 2](https://user-images.githubusercontent.com/78577071/127448215-7550c1ac-22a4-4179-acfc-b8ab84737867.png)

# 76ê°•-ëŒ“ê¸€ ë·° ë Œë”ë§.

ì ê¹! ìœ„ì˜ jsonê²°ê³¼ ìŠ¤ìƒ·ë³´ë©´ userì•ˆì˜ imageë¥¼ ë‹¤ ëŒê³ ì™”ë„¤. êµ³ì´ ê·¸ëŸ´ í•„ìš”ì—†ìœ¼ë‹ˆê¹Œ ignoreì²˜ë¦¬ ã„±ã„±

Comment.java

```jsx
...	
@JsonIgnoreProperties({"images"})
	@JoinColumn(name="userId")
	@ManyToOne(fetch=FetchType.EAGER)//ë§¤ë‹ˆíˆ¬ì›ì€ EAGERê°€ ë””í´íŠ¸
	private User user;
```

ì´ì œ images ì•ˆë“¤ê³ ì˜¨ë‹¤

![Untitled 3](https://user-images.githubusercontent.com/78577071/127448233-6c114b85-2f62-4b0a-a583-999ef7cfa874.png)


---

ì ì´ì œ ëìœ¼ë‹ˆ ë·°ì— ë¿Œë¦¬ì!

story.js ì˜ addComentì˜ ajaxì˜ doneì—ë‹¤ê°€ ë‹¤ìŒì²˜ëŸ¼ í•¨

```jsx
}).done(res=>{
		console.log("ì„±ê³µ",res);
		
		let comment = res.data;
	
		let content = `
		  <div class="sl__item__contents__comment" id="storyCommentItem-${comment.id}"> 
		    <p>
		      <b>${comment.user.username} :</b>
		      ${comment.content}
		    </p>
		    <button><i class="fas fa-times"></i></button>
		  </div>
		`;
		commentList.prepend(content);
		
	}).fail(error=>{
		console.log("ì˜¤ë¥˜",error);
	});

	commentInput.val("");//ì¸í’‹í•„ë“œë¥¼ ê°œë—í•˜ê²Œ ë¹„ì›Œì¤€ë‹¤
}
```

ì´ëŸ¼ ì´ì œ ëŒ“ê¸€ì“¸ë•Œë§ˆë‹¤ ëŒ“ê¸€ì— í•˜ë‚˜ì”© ë°”ë¡œë°”ë¡œ ì¶”ê°€ë˜ì„œ ë³´ì„

ì´ì œ í˜ì´ì§€ ë¶ˆëŸ¬ì˜¬ë•Œë„ ë³´ì´ê²Œ í•˜ì.(ì•„ì§ì€ ìƒˆë¡œê³ ì¹¨í•˜ë©´ í™”ë©´ì—ì„œ ì‚¬ë¼ì ¸)

ìŠ¤í† ë¦¬í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì• ëŠ” ImageApiControllerì˜ imageService.ì´ë¯¸ì§€ìŠ¤í† ë¦¬()ì¸ë° ì´ ë©”ì†Œë“œê°€ ë¦¬í„´í•˜ëŠ” Imageì— ì§€ê¸ˆ Commentê°€ ì—†ìœ¼ë¯€ë¡œ ë”í•´ì¤€ë‹¤

Image.javaì— ë‹¤ìŒì¶”ê°€

```jsx
@OrderBy("id DESC")	  //jpaí• ë• orderby ì´ë ‡ê²Œ ê±¸ìˆ˜ìˆìŒ
@JsonIgnoreProperties({"image"})
@OneToMany(mappedBy="image")//ì—°ê´€ê´€ê³„ ì£¼ì¸ì´ Commentì˜ imageë‹¤. ì¦‰ FKê°€ ì´ commentsê°€ ì•„ë‹ˆë¼ Commentì˜ imageì— ìƒê¸´ë‹¤
private List<Comment> comments;
```

ì´ì œ Imageëª¨ë¸ì— Commentê°€ ìƒê²¼ìœ¼ë‹ˆê¹Œ imageí†µí•´ì„œ commentì ‘ê·¼ê°€ëŠ¥

story.jsì˜ getStroyItem(image) ì— ë‹¤ìŒ ì²˜ë¦¬. **image.comments.forEach()**

```jsx
</div>

	<div id="storyCommentList-${image.id}">`;
	
		image.comments.forEach((comment)=>{
			item+=`	<div class="sl__item__contents__comment" id="storyCommentItem-${comment.id}">
			<p>
				<b>${comment.user.username} :</b> ${comment.content}
			</p>

			<button>
				<i class="fas fa-times"></i>
			</button>
		</div>`
		});
		
	item +=`
	</div>
```

ê²°ê³¼ ì„±ê³µ~
![Untitled 4](https://user-images.githubusercontent.com/78577071/127448259-e437240c-df2d-4168-9c0f-e87f34de9a87.png)

# 77ê°•-ëŒ“ê¸€ì‚­ì œí•˜ê¸°

xë²„íŠ¼ ëˆ„ë¥´ë©´ ì‚­ì œë˜ê²Œ!

ê·¼ë° ì‚­ì œí•˜ë ¤ë©´, ê·¸ ëŒ“ê¸€ì„ ì“´ ì‚¬ëŒì´ ë¡œê·¸ì¸í•œ ì‚¬ëŒì´ë‘ ê°™ì€ì§€ ë¹„êµí•´ì•¼í•˜ì–ì•„

ê·¼ë° ìŠ¤í† ë¦¬ í˜ì´ì§€ ì˜¤ë©´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” storyLoadí•¨ìˆ˜ì˜ getStroyItem()ì„ ë³´ë©´, principalIdë¥¼ ì–´ì¼€ ì°¾ì•„ì™€ì•¼ í• ì§€ ëª°ë¼

```jsx
function storyLoad() {
	$.ajax({
		url:`/api/image?page=${page}`,
		dataType:"json"
	}).done(res=>{
		console.log(res);
		res.data.content.forEach((image)=>{
			let storyItem = getStoryItem(image);
			$("#storyList").append(storyItem);
		})
	}).fail(error=>{
		console.log("ì˜¤ë¥˜	",error);
	});
}
storyLoad();
```

ë°©ë²•: header.jspì™€ì„œ bodyì œì¼ ì‹œì‘í•˜ëŠ” ì²˜ìŒì— ë‹¤ìŒì²˜ëŸ¼ ì²˜ë¦¬.

```jsx
<body>

	<!-- principalId ë‹´ì•„ë‘ëŠ” ê³³ -->
	<input type="hidden" id="principalId" value="${principal.user.id}"/>
```

ì´ì œ ë‹¤ì‹œ story.jsì˜ getStoryItem()ê°€ì„œ if(principalId == comment.user.id) êµ¬ë¬¸ ì¶”ê°€

```jsx
<div id="storyCommentList-${image.id}">`;
	
		image.comments.forEach((comment)=>{
			item+=`	<div class="sl__item__contents__comment" id="storyCommentItem-${comment.id}">
			<p>
				<b>${comment.user.username} :</b> ${comment.content}
			</p>`;
			
			if(principalId == comment.user.id){
				item+=`	<button>
						<i class="fas fa-times"></i>
						</button>`
			}
			
		item+=`
		</div>`
		});
```

ì´ì œ ë‹¤ë¥¸ì‚¬ëŒì´ ì“´ ëŒ“ê¸€ì€ xë²„íŠ¼ì´ ë³´ì´ì§€ ì•ŠìŒ. 

(loveë¡œ ë¡œê·¸ì¸í•˜ë©´ ssarì´ ì“´ ëŒ“ê¸€ì„ ëª»ì§€ìš´ë‹¤)

![Untitled 5](https://user-images.githubusercontent.com/78577071/127448278-ebda7b3d-13b7-447a-8e1f-0b12f1f19b16.png)

---

ì´ì œ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ë°˜ì‘ ã„±

ë²„íŠ¼ì— onclick ë„£ì–´ì£¼ê³ 

```jsx
if(principalId == comment.user.id){
				item+=`	<button onclick="deleteComment(${comment.id})">
						<i class="fas fa-times"></i>
						</button>`
			}
```

ê°™ì€ íŒŒì¼(story.js)ì˜ deleteCommentí•¨ìˆ˜ì— ajaxì²˜ë¦¬.

remove()í•˜ëŠ”ê±´ ì‚­ì œë²„íŠ¼ ëˆ„ë¥´ëŠ” ìˆœê°„ ë°”ë¡œ ê¸€ì”¨ ì‚­ì œì‹œí‚¤ëŠ”ê±°ì„

```jsx
// (5) ëŒ“ê¸€ ì‚­ì œ
function deleteComment(commentId) {
	$.ajax({
		type:"delete",
		url:`/api/comment/${commentId}`,
	}).done(res=>{
		console.log("ì„±ê³µ",res);
		$(`#storyCommentItem-${commentId}`).remove();
	}).fail(error=>{
		console.log("ì˜¤ë¥˜",error);
	});
}
```

CommentApiController

```jsx
@DeleteMapping("/api/comment/{id}")	public ResponseEntity<?> commentDelete(@PathVariable int id) {		commentService.ëŒ“ê¸€ì‚­ì œ(id);		return new ResponseEntity<>(new CMRespDto<>(1,"ëŒ“ê¸€ì‚­ì œì„±ê³µ", null),HttpStatus.OK);	}
```

CommentService

```jsx
@Transactional	public void ëŒ“ê¸€ì‚­ì œ(int id){		//í˜¹ì‹œ ì˜¤ë¥˜í„°ì§€ë©´ ë‹¤ìŒì²˜ëŸ¼ í•˜ë©´ëœë‹¤. 		try {			commentRepository.deleteById(id);		}catch(Exception e) {			throw new CustomApiException(e.getMessage());		}	}
```

ì˜¤ì¼€ì´ ì™„ë£Œ. 

---

ì•„ë‰˜ ê·¼ë° ë˜ í•´ì•¼ í• ê²Œ ìˆì–´. ë°©ê¸ˆ ëŒ“ê¸€ì“´ê±¸ ë°”ë¡œ ì‚­ì œë²„íŠ¼ ëˆ„ë¥´ë©´ ì‚­ì œê°€ ì•ˆë¼;;; ì™œ?

í˜ì´ì§€ ì²˜ìŒ ë¡œë”©í• ë•Œ ê°€ì ¸ì˜¤ëŠ” htmlì€ jsì—ì„œ itemì— í•©ì³ì„œ ë¿Œë ¤ì£¼ëŠ”ê±´ë° ë‹¤ìŒì²˜ëŸ¼ ë²„íŠ¼ì— onClickìœ¼ë¡œ deleteCommentí•¨ìˆ˜ ê±¸ì–´ë†¨ì–ì–´

```jsx
<div id="storyCommentList-${image.id}">`;
	
		image.comments.forEach((comment)=>{
			item+=`	<div class="sl__item__contents__comment" id="storyCommentItem-${comment.id}">
			<p>
				<b>${comment.user.username} :</b> ${comment.content}
			</p>`;
			
			if(principalId == comment.user.id){
				item+=`	<button onclick="deleteComment(${comment.id})">
						<i class="fas fa-times"></i>
						</button>`
			}
			
		item+=`
		</div>`
```

ê·¼ë° ëŒ“ê¸€ë‹¬ë•Œ ìë™ìœ¼ë¡œìƒê¸°ëŠ” ëŒ“ê¸€ì€ ì§€ê¸ˆ ë²„íŠ¼ì— ì•„ë¬´ ì²˜ë¦¬ì•ˆí•´ë†”ì„œ ê·¸ë˜.

```jsx
let content = `
		  <div class="sl__item__contents__comment" id="storyCommentItem-${comment.id}"> 
		    <p>
		      <b>${comment.user.username} :</b>
		      ${comment.content}
		    </p>
		    <button><i class="fas fa-times"></i></button>
		  </div>
		`;
```

ë²„íŠ¼ì— ê± ë˜‘ê°™ì´ ì˜¨í´ë¦­ ë³µë¶™. ë²„íŠ¼ì‘ì„±ìëŠ” ì–´ì°¨í”¼ ë°©ê¸ˆì‘ì„±í•œ ì‚¬ëŒì´ë‹ˆê¹Œ ë¡œê·¸ì¸í•œì‚¬ëŒì´ë¼ì„œ ë¹„êµí•  í•„ìš” ì—†ìŒ

```jsx
<button onclick="deleteComment(${comment.id})"><i class="fas fa-times"></i></button>
```

ì„±ê³µ!!

![Untitled 6](https://user-images.githubusercontent.com/78577071/127448318-a1fb3f32-cdb2-4dfe-a430-eae6838a30d4.png)


# 78ê°•- ìœ íš¨ì„± ê²€ì‚¬

notBlank ê±¸ê³ 

```jsx
//NotNull=Nullê°’ì²´í¬
//NotEmpty=ë¹ˆê°’("")|null|ë¹ˆê³µë°±("  ") ì²´í¬
//NotBlacnk=ë¹ˆê°’|null ì²´í¬
@Data
public class CommentDto {
	@NotBlank 
	private String content;
	@NotNull
	private Integer imageId;
	
	//toEntityê°€ í•„ìš”ì—†ë‹¤
}
```

CommentApiController ê°€ì„œ @Validê±¸ê³  BindingResultë¥¼ ë°”ë¡œ ë‹¤ìŒì¸ìë¡œ ë°›ê³ , ifë¬¸ ì¶”ê°€í•´ì„œ ìµì…ˆì…˜ì„ í•¸ë“¤ëŸ¬ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ì²˜ë¦¬

```jsx
@PostMapping("/api/comment")
	public ResponseEntity<?> commentSave(@Valid @RequestBody CommentDto commentDto,BindingResult bindingResult,@AuthenticationPrincipal PrincipalDetails principalDetails) {
		
		if(bindingResult.hasErrors()) {
			Map<String,String> errorMap = new HashMap<>();
			for(FieldError error: bindingResult.getFieldErrors()){
				errorMap.put(error.getField(), error.getDefaultMessage());
			}
			throw new CustomValidationApiException("ìœ íš¨ì„±ê²€ì‚¬ ì‹¤íŒ¨í•¨",errorMap);
		}
		
		Comment comment = commentService.ëŒ“ê¸€ì“°ê¸°(commentDto.getContent(), commentDto.getImageId(), principalDetails.getUser().getId());//content,imageId,userId ë‚ ë¦¼
		return new ResponseEntity<>(new CMRespDto<>(1,"ëŒ“ê¸€ì“°ê¸°ì„±ê³µ",comment),HttpStatus.CREATED);
	}
```

story.jsì— ê°€ì„œ ì´ì œ ajaxì˜ failì—ë‹¤ê°€ alertí‘œì‹œí•¨.

ê·¼ë° ì–´ì°¨í”¼ ì•ì—ì„œ if (data.content === "") ë¡œ ë§‰ì•„ì„œ ì´ëŸ° ajaxê¹Œì§€ ì•ˆë„˜ì–´ê°€ê¸´ í• í…ë° ì•ˆì „ì„ ìœ„í•´ì„œ..

```jsx
// (4) ëŒ“ê¸€ì“°ê¸°
function addComment(imageId) {

	let commentInput = $(`#storyCommentInput-${imageId}`);
	let commentList = $(`#storyCommentList-${imageId}`);

	let data = {
		imageId:imageId,
		content: commentInput.val()
	}

	if (data.content === "") {
		alert("ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”!");
		return;
	}
	
	$.ajax({
		type:"post",
		url:"/api/comment",
		data:JSON.stringify(data),
		contentType:"application/json;charset=utf-8",
		dataType:"json"
	}).done(res=>{
		console.log("ì„±ê³µ",res);
		
		let comment = res.data;
	
		let content = `
		  <div class="sl__item__contents__comment" id="storyCommentItem-${comment.id}"> 
		    <p>
		      <b>${comment.user.username} :</b>
		      ${comment.content}
		    </p>
		    <button onclick="deleteComment(${comment.id})"><i class="fas fa-times"></i></button>
		  </div>
		`;
		commentList.prepend(content);
		
	}).fail(error=>{
		console.log("ì˜¤ë¥˜",error.responseJSON.data.content);
		alert(error.responseJSON.data.content);
	});

	commentInput.val("");//ì¸í’‹í•„ë“œë¥¼ ê°œë—í•˜ê²Œ ë¹„ì›Œì¤€ë‹¤
}
```
